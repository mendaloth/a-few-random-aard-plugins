<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, August 06, 2008, 1:13 PM -->
<!-- MuClient version 4.35 -->

<!-- Plugin "Consider_info" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Channel_Snoozer"
   author="Mendaloth"
   id="c2beb198a065f7e7e50a92d7"
   language="Lua"
   purpose="Toggle channels off for a set amount of times"
   date_written="2008-10-15 07:35"
   requires="4.30"
   version="1.0"
   save_state="y"
   >
<description trim="y">
<![CDATA[
Channel Snoozer 1.0

<=================== ACTIONS ===================>
snooze <chan> <minutes>        --> Will snooze channel <chan> for <minutes>.
snooze help                    --> This help file.
                                 
]]>
</description>

</plugin>


<!--  Triggers  -->

<triggers>

</triggers>

<aliases>
  <alias
   match="snooze *"
   enabled="y"
   echo_alias="y"
   send_to="12"
   sequence="101">
  <send>
    if "%1" == "help" then
      Note(GetPluginInfo(GetPluginID(), 3))
	else
		Note("Unknown command sent to channel snoozer. Type snooze help for a full listing of commands.")
    end
  </send>
</alias>  

 <alias
   match="snooze * *"
   enabled="y"
   echo_alias="y"
   send_to="12"
   sequence="100">
  <send>
	if (tonumber("%2") == nil) then
		Note("Invalid number.  You must enter a valid number of minutes.")
	else
		--First turn the channel off.
		SendNoEcho("%1") 
		Note("Turning off '%1' channel.  It will be toggled back on in %2 minutes.")
		--Channel is off setup timer to turn it back on
		Start_Toggle_Chan_Timer("%1", tonumber("%2"))
    end
  </send>
</alias>  
</aliases>

<!--  Script  -->

<script>
<![CDATA[
function Start_Toggle_Chan_Timer(channel, time_in_minutes)
	local time_in_seconds = time_in_minutes * 60
	DoAfterSpecial (time_in_seconds, "ToggleChanOn('".. channel .."')", sendto.script)
end

function ToggleChanOn(channel_name) 
	local player_state = Get_Current_State_Number()
	
	--Check the player stat to make sure they aren't AFK, ETC...
	if (player_state == 1) then
		--1         At login screen, no player yet
		SnoozeTheSnooze("You are at login screen", channel_name)
	elseif (player_state == 2) then
		--2         Player at MOTD or other login sequence
		SnoozeTheSnooze("You are at login screen", channel_name)
	elseif (player_state == 4) then
		--4         Player AFK
		SnoozeTheSnooze("You are AFK", channel_name)
	elseif (player_state == 5) then
		--5         Player in note 
		SnoozeTheSnooze("You are writing a note", channel_name)
	elseif (player_state == 6) then
		--6         Player in Building/Edit mode
		SnoozeTheSnooze("You are in building/edit mode", channel_name)
	elseif (player_state == 7) then
		--7         Player at paged output prompt
		SnoozeTheSnooze("You are at paged output prompt", channel_name)
	else
		--Remaining states are all good so toggle the channel back on
		SendNoEcho(channel_name)
		Note("The '" .. channel_name .. "' channel has been toggled back on.")
		if (IsPluginInstalled("b555825a4a5700c35fa80780")) then
			--Put a message in the comm log if it is installed.
			CallPlugin("b555825a4a5700c35fa80780","storeFromOutside","@x157The '" .. channel_name .. "' channel has been toggled back on.")
		end
	end
end

function Get_Current_State_Number()
	local rest
	local state_num
	res, state_num = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.state")
	
	return tonumber(state_num)
end

function SnoozeTheSnooze(reason, channel_name)
	DoAfterSpecial (30, "ToggleChanOn('".. channel_name .."')", sendto.script) --snooze the snooze 30 seconds
	--Let the user know why we are snoozing
	Note(reason .. ", waiting 30 seconds to toggle the '" .. channel_name .. "' channel back on.")
end		

]]>
</script>

</muclient>