<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, October 08, 2010, 6:26 PM -->
<!-- MuClient version 4.61 -->

<!-- Plugin "Wordgame" generated by Plugin Wizard -->

<muclient>
<plugin
   name="AardwolfExperienceReporter"
   author="Mendaloth"
   id="53afe1da36641d9950074f25"
   language="Lua"
   purpose="Reports information on percent of experience and levels you have gained."
   save_state="y"
   date_written="2010-10-08 18:25:13"
   requires="4.61"
   version="1.0"
   >
   
<description trim="n">
<![CDATA[
--------------------------------------------------------------------------------
Aardwolf Experience Reporter v1.0.9 Help

progress <channel>               -  Will send to the <channel> a players total
                                    experience, total levels, and SHs remaining
                                    until T9 SH.
								
progress hypo <channel> TxRxLx   -  Will send to the <channel> a hypothetical players
                                    total experience, total levels, and SHs remaining 
                                    until T9 SH.
									
progress other <name> <channel>  -  Will finger player with <name> and capture that
                                    players progress compared to a T9 SH and send that
                                    information to the <channel>.

progress toggle expsetting       -  A change in July 2012 decreased the exp for T0/T1
                                    players.  When this is ON, the plugin will calculate
                                    your exp using the lower exp for T0/T1.  For now
                                    this setting defaults to off, and won't save across
                                    sessions.
									
progress help                    -  Displays this help file.
									
]]>
</description>   

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  
  
</triggers>


<!--  Aliases  -->

<aliases>  
	<alias
		match="progress *"
		enabled="y"
		sequence="5"
		expand_variables="y"
		ignore_case="y"
		send_to="12"
	>
		<send>
			Send_Progress_Info("%1", Get_Current_Player_Name(), Get_Current_Tier(), Get_Current_Level(), Get_Current_Remort(), Get_Current_TNL(), Get_Current_Redo())
		</send>
	</alias>

	<alias
		match="progress hypo * T*R*L*"
		enabled="y"
		sequence="1"
		expand_variables="y"
		ignore_case="y"
		send_to="12"
	>
		<send>
			local tier = tonumber("%2")
			local remort = tonumber("%3")
			local level = tonumber("%4") 

			if (tier == nil or tier > 9) then
				Note("You must number 9 or below for tier.")
				return
			elseif (remort == nil or remort >7) then
				Note("You must enter a number 7 or below for remort.")
				return
			elseif (level == nil or level >201) then
				Note("You must enter a number 201 or below for level.")
				return
			end

			Send_Progress_Info("%1", "For a player at ", tier, level, remort, 0)
		</send>
	</alias>
  
  
	<alias
		match="progress other * *"
		enabled="y"
		sequence="1"
		expand_variables="y"
		ignore_case="y"
		send_to="12"
	>
		<send>
			channel_to_send_to = "%2"
			player_name_to_finger = "%1"
			Capture_Other_Player_Info()
		</send>
	</alias>
  
	<alias
		match="progress help"
		enabled="y"
		send_to="12"
		sequence="1"
		ignore_case="y"
	>
		<send>
			Note(GetPluginInfo (GetPluginID(), 3))
		</send> 
	</alias>
	
	<alias
	match="progress toggle expsetting"
	enabled="y"
	send_to="12"
	sequence="1"
	ignore_case="y"
	>
	<send>
		if (exp_setting) then
			exp_setting = false
			Note("The experience will be calculated with the values from before T0/T1 experience was changed in July 2012.")
		else
			exp_setting = true
			Note("The experience will be calculated with the new values for T0/T1 experience from the July 2012 changes.")
		end
	</send> 
	</alias>
</aliases>

<!--  Script  -->


<script>
<![CDATA[

save_state="y"

require "commas"
require "addxml"

channel_to_send_to = ""
player_name_to_finger = ""
captured_players_remort = 0
captured_players_tier = 0
captured_players_level = 0
captured_players_redo = 0

experience_first_color = "@x039"
experience_second_color = "@x165"


function Send_Progress_Info(send_to, player_name, player_tier, player_level, player_remort, tnl_until_next_level, player_redos)
	local total_levels = 0
	local total_exp = 0
	local total_remorts = 0
	local current_tier_exp = 0
	local players_total_levels = 0
	local players_total_exp = 0
	local players_total_remorts = 0

	local total_levels_before_redo = 0
	local total_remorts_before_redo = 0
	local total_experience_before_redo = 0
	
	for tier_counter = 0, 9+player_redos, 1 do
		for remort_counter = 1, 7, 1 do
			local current_tnl = tnl(tier_counter, remort_counter)
			
			if (player_tier+player_redos == tier_counter and player_remort == remort_counter) then
				players_total_levels = total_levels + player_level
				players_total_remorts = total_remorts  -- I assign this value before adding 1 to total_remorts later in this function because players_total_remorts is count of completed remorts
				if (player_level >= 200) then -- You don't actually have to earn any exp to get a level above 200
					if (player_level >= 201) then
						players_total_remorts = players_total_remorts + 1 -- Add 1 here since they already SHd
					end	
					players_total_exp = total_exp + current_tier_exp + (199 * current_tnl)
				else
					players_total_exp = total_exp + current_tier_exp + ((player_level-2) * current_tnl)	+ (current_tnl-tnl_until_next_level) -- shoudl this be -2 or -1
				end
			end
			
			total_remorts = total_remorts + 1
			
			current_tier_exp = current_tier_exp + (199 * current_tnl)
			total_levels = total_levels +201
			if (remort_counter == 7 and tier_counter == 9 and player_redos > 0) then
				total_levels_before_redo = total_levels
				total_remorts_before_redo = total_remorts
				total_experience_before_redo = current_tier_exp + total_exp
			end
		end
		total_exp = current_tier_exp + total_exp
		current_tier_exp = 0
	end
	
	if (player_redos < 1) then
		local percent_exp = string.format("%.2f", players_total_exp/total_exp*100).. "%"
		local percent_levels = string.format("%.2f", players_total_levels/total_levels*100).. "%"
		local superheros_left = total_remorts - players_total_remorts
		local percent_superheros_left = string.format("%.2f", superheros_left/total_remorts*100).. "%"
		local player_info = " " .. experience_first_color .. player_name.." T"..player_tier.."R"..player_remort.."L"..player_level
		SendNoEcho(send_to .. player_info .. " " .. experience_first_color .. "Levels - ".. percent_levels .. " " .. experience_second_color .. "(" .. experience_first_color .. ""..commas(players_total_levels).."" .. experience_second_color .. "/" .. experience_first_color .. ""..commas(total_levels).. "" .. experience_second_color .. ") | " .. experience_first_color .. "Experience - "..percent_exp .. " " .. experience_second_color .. "(" .. experience_first_color .. ""..commas(players_total_exp).."" .. experience_second_color .. "/" .. experience_first_color .. ""..commas(total_exp).. "" .. experience_second_color .. ") | "  .. experience_first_color .. "SHs Left - ".. percent_superheros_left .. " " .. experience_second_color .. "(" .. experience_first_color .. ""..commas(superheros_left).."" .. experience_second_color .. "/" .. experience_first_color .. ""..commas(total_remorts).. "" .. experience_second_color .. ")")
	else
		local percent_exp = string.format("%.2f", players_total_exp/total_experience_before_redo*100).. "%"
		local percent_levels = string.format("%.2f", players_total_levels/total_levels_before_redo*100).. "%"
		local superheros_left = total_remorts - players_total_remorts -- might not be used?
		local percent_superheros_left = string.format("%.2f", players_total_remorts/total_remorts_before_redo*100).. "%"
		local player_info = ""
		
		if (player_redos == 1) then
			player_info = " " .. experience_first_color .. player_name.." T"..player_tier .. "R"..player_remort.."L"..player_level .. " @W(1 Redo)"
		else
			player_info = " " .. experience_first_color .. player_name.." T"..player_tier .. "R"..player_remort.."L"..player_level .. " @W(".. player_redos .. " Redos)"
		end
		
		local exp_text = "" .. experience_second_color .. ") | " .. experience_first_color .. "Experience - "..percent_exp .. " " .. experience_second_color .. "(" .. experience_first_color .. ""..commas(players_total_exp).."" .. experience_second_color .. "/" .. experience_first_color .. ""..commas(total_experience_before_redo).. "" .. experience_second_color
		
		local level_text = experience_first_color .. "Levels - ".. percent_levels .. " " .. experience_second_color .. "(" .. experience_first_color .. ""..commas(players_total_levels).."" .. experience_second_color .. "/" .. experience_first_color .. ""..commas(total_levels_before_redo)
		
		local SH_text = ") | "  .. experience_first_color .. "SHs Complete - ".. percent_superheros_left .. " " .. experience_second_color .. "(" .. experience_first_color .. ""..commas(players_total_remorts).."" .. experience_second_color .. "/" .. experience_first_color .. ""..commas(total_remorts_before_redo).. "" .. experience_second_color .. ")"
		
		SendNoEcho(send_to .. player_info .. " " .. level_text .. exp_text .. SH_text)
	end
end

function tnl(tier,remort)
-- A big thank you to Etzli for providing the meat of this function
-- and the needed kick in the butt to finally complete this project
-- I had been thinking about for a while.  All of the good things
-- in the function are his, all mistakes and errors are Mendaloth's alone :).
-- Added changes to reflect July 31, 2012 reboot
--
	local new_max_tnl = 10000

	if (tier == 0) then
		if (exp_setting) then
			new_max_tnl = 3000
		else
			new_max_tnl = 5000
		end
	end
	
	if (tier == 1) then
		if (exp_setting) then
			new_max_tnl = 4000
		else
			new_max_tnl = 5000
		end
	end
	
	if (tier > 9) then
		new_max_tnl = 5000
	end
	
	if (tier == 0 or tier > 9) then
		tier = 1
	end

	local tnlval=tier*1000

	if (tier == 1) then
		tnlval = 1000
	end

	if remort < 6 then
		tnlval=tnlval+((remort-1)*1000)
	else
		tnlval=tnlval+(4*1000)
	end
	if tnlval > new_max_tnl then
		tnlval=new_max_tnl
	end
	return tnlval
end

function Get_Current_Level()
	local rest
	local charlevel
	res, charlevel = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.level")
	
	return tonumber(charlevel)
end -- function

function Get_Current_Tier()
	local rest
	local chartier
	res, chartier = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.base.tier")

	return tonumber(chartier)
end

function Get_Current_Remort()
	local rest
	local charremorts
	res, charremorts = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.base.remorts")

	return tonumber(charremorts)
end

function Get_Current_TNL()
	local rest
	local charcurrenttnl
	res, charcurrenttnl = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.tnl")

	return tonumber(charcurrenttnl)
end

function Capture_Other_Player_Info()
	captured_players_remort = 1
	captured_players_tier = 0
	captured_players_level = 0
	captured_players_redo = 0
	Capture_Between_Tags("{start_finger_capture_exp_progress}", "{end_finger_capture_exp_progress}", "Process_Finger_Line", true)
	SendNoEcho("echo {start_finger_capture_exp_progress}")
	SendNoEcho("finger "..player_name_to_finger)
	SendNoEcho("echo {end_finger_capture_exp_progress}")
end

function Process_Finger_Line(name, line, wildcards, styles)
	if (string.find(line, "Remort", 0, true) ~= nil) then
		-- If the player is on their first mort the Remort line does not
		-- appear so the captured_player_remort is set to 1 in the
		-- Capture_Other_Player_Info function.
		local pos = 0
		captured_players_remort = 1
		for st,sp in function() return string.find(line,"/",pos,true) end do
			captured_players_remort = captured_players_remort + 1
			pos = sp + 1 -- Jump past current slash
		end
	end

	if (line == "------------------------------------------------------------") then --done with capture
		local title_case_player = player_name_to_finger:gsub("^%l", string.upper)
		Send_Progress_Info(channel_to_send_to, title_case_player, captured_players_tier, captured_players_level, captured_players_remort, 1, captured_players_redo)
	end
	
	s, e, test = rex.new ("Level (?P<level>\\d+) (.+) \\(Tier (?P<tier>\\d+)\\+?(?P<redo>\\d+)?"):match (line)
	
	if (test ~=nil) then
		captured_players_tier = tonumber(test['tier'])
		captured_players_level = tonumber(test['level'])
		captured_players_redo = tonumber(test['redo']) or 0
	end
end

function Capture_Between_Tags(start_tag, end_tag, send_to_function, omit_from_output_val, regex_val, one_shot_val) 
-- Mendaloth's utlility function Capture_Between_Tags ver 1.00
-- omit_from_output is optional, defaults to false
-- regex is optional, defaults to false, and you must supply omit_from_output in order to use it
-- oneshot is optional, defaults to false, and you must supply omit_from_output and regex in order to use it
	if (omit_from_output_val == nil) then
		omit_from_output_val = false
	end
	

	if (regex_val == nil) then
		regex_val = false
	end
	
	if (one_shot_val == nil) then
		one_shot_val = false
	end

	local unique_id = GetUniqueNumber()
	
	--Open tag trigger
	addxml.trigger {  match = start_tag, 
			regexp = regex_val,
			enabled = true,
			one_shot = one_shot_val,
			sequence = 50,
			omit_from_output = omit_from_output_val,
			name = "starting_tag"..unique_id,
			send_to = 12,
			send = "EnableTrigger('ending_tag'.."..unique_id..", true)	EnableTrigger('capture_all'.." .. unique_id .. ", true)"
		  }

	addxml.trigger {  match = end_tag, 
			regexp = regex_val,
			enabled = false,
			one_shot = one_shot_val,
			omit_from_output = omit_from_output_val,
			name = "ending_tag"..unique_id,
			sequence = 5,
			send_to = 12,
			send = "EnableTrigger('ending_tag'.."..unique_id..", false)	EnableTrigger('capture_all'.." .. unique_id .. ", false)"
		  }
		  
	addxml.trigger {     match="^.*$",
		regexp = true,
		enabled = false,
		omit_from_output = omit_from_output_val,
		sequence = 50,
		keep_evaluating=false,
		name = "capture_all"..unique_id,
		script = send_to_function
	}
		  
end

function Get_Current_Redo()
	local rest
	local charcurrentredo
	res, charcurrentredo = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.base.redos")
	
	return tonumber(charcurrentredo)
end

function Get_Current_Player_Name()
	local rest
	local charname
	res, charname = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.base.name")

	return charname
end
]]>
</script>


</muclient>
