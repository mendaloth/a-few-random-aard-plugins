<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, August 06, 2008, 1:13 PM -->
<!-- MuClient version 4.35 -->

<!-- Plugin "Consider_info" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Aardwolf_Inst_Mastery_Reporter"
   author="Mendaloth"
   id="2d3da27571fb55279183b183"
   language="Lua"
   purpose="Reports your instinct and mastery to room or a channel."
   date_written="2008-10-15 07:35"
   requires="4.30"
   version="1.0"
   save_state="y"
   >
<description trim="y">
<![CDATA[
Aardwolf Instinct/Mastery Reporter v 1.01
<================================ ACTIONS =================================>
help report                --> Displays this help file and the mudside help
                             >  file for the report command.
report instinct <chan>     --> Reports instinct. If <chan> is omitted 
                             > reports to the room.  WARNING: the plugin
                             > does not work if your page size is less than
                             > 51.
report mastery  <chan>     --> Reports mastery. If <chan> is omitted reports
                             >  to the room.
----------------------------------------------------------------------------
]]>
</description>

</plugin>


<!--  Triggers  -->

<triggers>

<trigger
   enabled="n"
   regexp="y"
   omit_from_output="y"
   match="^                                                   ---- Next Cost ----$"
   sequence="100"
   name="instinct_capture_start"
   group="instinct_capture"
   send_to = "12"
  >
   <send>
	EnableTriggerGroup("instinct_capture", true)
  </send>
>
</trigger>

<trigger
   enabled="n"
   regexp="y"
   omit_from_output="y"
   match="^You have (.*?) trains? available for instinct.$"
   sequence="95"
   group="instinct_capture"
   send_to = "12"
  >
   <send>
    EnableTrigger("paging_prompt", false)
	EnableTriggerGroup("instinct_capture", false)
	Done_Instinct_Capture("%1")
  </send>
>

</trigger>

<trigger
   enabled="n"
   regexp="y"
   omit_from_output="n"
   match="^\[ Paging \:(.*?)$"
   sequence="90"
   send_to="12"
   name="paging_prompt"
   script="On_Paging_Error"
>
</trigger>

<trigger
   enabled="n"
   regexp="y"
   omit_from_output="y"
   match="^(.*?)$"
   sequence="100"
   send_to="12"
   group="instinct_capture"
   script="Process_Instinct_Line"
>
</trigger>

<trigger
   enabled="n"
   regexp="n"
   omit_from_output="y"
   match="*Mastery QP      Gold*"
   sequence="100"
   name="mastery_capture_start"
   group="mastery_capture"
   send_to = "12"
  >
   <send>
	EnableTriggerGroup("mastery_capture", true)
  </send>
>
</trigger>

<trigger
   enabled="n"
   regexp="n"
   omit_from_output="y"
   match="Water*"
   sequence="95"
   group="mastery_capture"
   send_to = "12"
  >
   <send>
    EnableTrigger("paging_prompt", false)
	EnableTriggerGroup("mastery_capture", false)
	Done_Mastery_Capture()
  </send>
>

</trigger>
<trigger
   enabled="n"
   regexp="y"
   omit_from_output="y"
   match="^(.*?)$"
   sequence="100"
   send_to="12"
   group="mastery_capture"
   script="Process_Mastery_Line"
>
</trigger>
</triggers>

<aliases>	  
<alias
   match="help report"
   enabled="y"
   echo_alias="y"
   send_to="12"
   sequence="101">
  <send>
    Note(GetPluginInfo(GetPluginID(), 3))
	SendNoEcho("help report") --The mud side help file should be displayed as well.
  </send>
</alias> 

<alias
   match="report help"
   enabled="y"
   echo_alias="y"
   send_to="12"
   sequence="101">
  <send>
    Note(GetPluginInfo(GetPluginID(), 3))
	SendNoEcho("report help") --The mud side help file should be displayed as well.
  </send>
</alias> 

<alias
   match="^report (instinct|mastery) (.*?)$"
   regexp = "y"
   enabled="y"
   echo_alias="y"
   send_to="12"
   sequence="95">
  <send>
		if ("%1" == "instinct") then
			report_channel = "%2"
			Refresh_Instinct_Amounts()
		else 
			report_channel = "%2"
			Refresh_Mastery_Amounts()
		end
  </send>
</alias> 
  
<alias
   match="^report (instinct|mastery)$"
   regexp = "y"
   enabled="y"
   echo_alias="y"
   send_to="12"
   sequence="95">
  <send>
		if ("%1" == "instinct") then
			report_channel = ""
			Refresh_Instinct_Amounts()
		else 
			report_channel = ""
			Refresh_Mastery_Amounts()
		end
  </send>
</alias>  
</aliases>
<!--  Script  -->


<script>
<![CDATA[

require "tprint"

first_color = "@G"
second_color = "@w"
seperator_color = "@C"

instinct = {}
mastery = {}
report_channel = ""

function trim(s)
  return (s:gsub("^%s*(.-)%s*$", "%1"))
end

function Refresh_Instinct_Amounts()
	EnableTrigger("instinct_capture_start", true)
	EnableTrigger("paging_prompt", true)
	SendNoEcho("instinct all")
end

function Process_Instinct_Line(_, line, _, _)
	--Note("Line is " .. line)
	if (string.sub(line, 1, 1) == "-" or trim(line) == "") then
		--It's a blank line or filled with -, do nothing.
	else
		local skill_name = trim(string.sub(line, 11, (11+22)))
		
		if (skill_name == "Skill name") then
			--This is the first line so just ignore it.
			return
		end
		instinct_amount = tonumber(trim(string.sub(line, 42, (42+8))))
		
		if (instinct_amount == nil) then
			--This will capture prompts so just ignore them.
			return
		end
		
		instinct[skill_name] = {}
		
		instinct[skill_name].instinct_bought = instinct_amount
	end
end

function Done_Instinct_Capture(trains_available)
	local formatted_info = ""
	local highest_instinct = Find_Highest_Instinct()
	local grouped_instincts = {}
	
	if (highest_instinct == 0) then
		--Special case have NO instinct.
		if (report_channel == "") then
			SendNoEcho("emote reports their instinct: They have ZERO instinct. ")
		else
			SendNoEcho(report_channel .. " reports their instinct: They have ZERO instinct.")
		end
		return
	end
	
	--Count down from highest instinct to lowest
	for i = highest_instinct, 1, -1 do
		for key, value in pairs(instinct) do
			if (value.instinct_bought == i) then
				--Check to see if we have an instinct at that level already
				local group_exists = false
				for key2, value2 in pairs(grouped_instincts) do
					if (value2.amount == i) then
						group_exists = true
						table.insert(grouped_instincts[key2].instincts, key)
					end
				end
				if (group_exists == false) then
					--first instinct we've seen with this amount bought so add it.
					table.insert(grouped_instincts, {amount=i, instincts = {key}})
				end
			end
		
		end
	end
	
	--First create an array which is all the instincts at the same level formatted
	local text_of_grouped_instinct = {}
	for key, value in pairs(grouped_instincts) do
		table.insert(text_of_grouped_instinct, first_color .. table.concat(value.instincts, second_color .. ", " .. first_color) .. second_color ..": " .. value.amount)
	end
	
	local remove_commas = string.gsub(trains_available, ",", "")
	
	trains_available = tonumber(remove_commas) --remove any separators and convert to a number.
	
	--if (trains_available) then
		--trains_available = 0  --something has gone wrong set it to zero.
	--end
	
	if (trains_available == 1) then
		table.insert(text_of_grouped_instinct, first_color .. "Train Available" .. second_color ..": " .. trains_available)
	else
		table.insert(text_of_grouped_instinct, first_color .. "Trains Available" .. second_color ..": " .. trains_available)
	end
	
	--Now that we have all the instincts at same level formatted and in their own rows by the amount purchased
	-- combine them into one single string so you can display it.
	formatted_info = table.concat(text_of_grouped_instinct, seperator_color .. " | ")
	
	if (report_channel == "") then
		SendNoEcho("emote reports their instincts: " .. formatted_info)
	else
		SendNoEcho(report_channel .. " " .. seperator_color .. "Instincts " ..  formatted_info)
	end
end

function Refresh_Mastery_Amounts()
	EnableTrigger("mastery_capture_start", true)
	EnableTrigger("paging_prompt", true)
	SendNoEcho("mastery")
end

function Find_Highest_Instinct()
	local highest = 0
	for key, value in pairs(instinct) do
		if (value.instinct_bought > highest) then
			highest = value.instinct_bought
		end
	end
	return highest
end

function Process_Mastery_Line(_, line, _, _)
	--Note("Line is " .. line)
	if (string.sub(line, 1, 1) == "-" or trim(line) == "") then
		--It's a blank line or filled with -, do nothing.
	else
		local mastery_name = trim(string.sub(line, 0, 13))
		if (mastery_name == "Damage Type") then
			--This is the first line so just ignore it.
			return
		end
	
		local mastery_amount = tonumber(trim(string.sub(line, 14, (14+7))))
		
		if (mastery_amount == nil) then
			--This will capture prompts - which won't have a mastery amount - so just ignore them.
			return
		end
		
		mastery[mastery_name] = {}
		
		mastery[mastery_name].mastery_bought = mastery_amount
	end
end

function Done_Mastery_Capture()
	local formatted_info = ""
	local highest_mastery = Find_Highest_Mastery()
	local grouped_masterys = {}
	
	if (highest_mastery == 0) then
		--Special case have NO mastery.
		if (report_channel == "") then
			SendNoEcho("emote reports their mastery: They have ZERO mastery. ")
		else
			SendNoEcho(report_channel .. " reports their mastery: They have ZERO mastery.")
		end
		return
	end
	
	--Count down from highest mastery to lowest
	for i = highest_mastery, 1, -1 do
		for key, value in pairs(mastery) do
			if (value.mastery_bought == i) then
				--Check to see if we have an mastery at that level already
				local group_exists = false
				for key2, value2 in pairs(grouped_masterys) do
					if (value2.amount == i) then
						group_exists = true
						table.insert(grouped_masterys[key2].masterys, key)
					end
				end
				if (group_exists == false) then
					--first mastery we've seen with this amount bought so add it.
					table.insert(grouped_masterys, {amount=i, masterys = {key}})
				end
			end
		
		end
	end
	
	--First create an array which is all the masterys at the same level formatted
	local text_of_grouped_mastery = {}
	for key, value in pairs(grouped_masterys) do
		table.insert(text_of_grouped_mastery, first_color .. table.concat(value.masterys, second_color .. ", " .. first_color) .. second_color ..": " .. value.amount)
	end
	
	--Now that we have all the mastery at same level formatted and in their own rows by the amount purchased
	-- combine them into one single string so you can display it.
	formatted_info = table.concat(text_of_grouped_mastery, seperator_color .. " | ")
	
	if (report_channel == "") then
		SendNoEcho("emote reports their mastery levels: " .. formatted_info)
	else
		SendNoEcho(report_channel .. " " .. seperator_color .. "Masteries " .. formatted_info)
	end
end

function Find_Highest_Mastery()
	local highest = 0
	for key, value in pairs(mastery) do
		if (value.mastery_bought > highest) then
			highest = value.mastery_bought
		end
	end
	return highest
end

function On_Paging_Error()	
	EnableTriggerGroup("instinct_capture", false)
	EnableTriggerGroup("mastery_capture", false)
	EnableTrigger("paging_prompt", false)
	Note("Oops, a paging prompt interupted the capture.  Set your pagesize higher and then try again.")
end

]]>
</script>

</muclient>